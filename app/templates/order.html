<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>mKelner ‚Äì Nowe zam√≥wienie</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/css.css') }}">
  <style>
    .order-wrapper { display: flex; gap: 20px; padding: 0 30px; }
    .category-tabs { flex: 0 0 15%; display: flex; flex-direction: column; gap: 5px; }
    .category-tab { padding: 10px; cursor: pointer; background: #eee; border: none; text-align: left; }
    .category-tab.active { font-weight: bold; background: #ddd; }
    .menu-display { flex: 0 0 55%; }
    .menu-category { display: none; }
    .menu-category.active { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; }
    .menu-item { border: 1px solid #ccc; padding: 10px; background: #fff; cursor: pointer; }
    .order-summary { background-color: #fff8dc; padding: 10px; margin-bottom: 20px; }
    .right-panel { flex: 0 0 30%; display: flex; flex-direction: column; gap: 20px; }
    .client-section { background: #f9f9f9; padding: 10px; border: 1px solid #ccc; }
    .success-message { background: #d4edda; padding: 10px; color: #155724; margin-top: 10px; display: none; }
    .tables { margin-top: 20px; display: flex; flex-direction: column; gap: 5px; }
    .tables button { padding: 5px 10px; border: none; cursor: pointer; }
    .stol-op { background-color: #fff3cd; }
    .stol-oj { background-color: #d1ecf1; }
    .stol-re { background-color: #f8d7da; }
    .stol-wolny { background-color: #d4edda; }
    .client-section input,
    .client-section select { width: 100%; box-sizing: border-box; }
    .info-red { color: #b00020; font-weight: bold; }
    #allergyList label {display: inline-block;width: 100%;padding: 4px 0;}
    #allergyList input[type="checkbox"] {margin-right: 8px;transform: scale(1.2);vertical-align: middle;
  </style>
</head>
<script>var menuData = {};</script>
<script>menuData = {{ menu|tojson }};</script>
<body>
  <aside>
    <h2>mKelner</h2>
    <nav>
      <a href="{{ url_for('menu_page') }}">Menu</a>
      <a href="{{ url_for('order_page') }}" class="active">Zam√≥wienia</a>
      <a href="{{ url_for('users_page') }}">U≈ºytkownicy</a>
      <a href="{{ url_for('stats_page') }}">Statystyka</a>
      <a href="{{ url_for('order_routes.history_page') }}">Historia Zam√≥wie≈Ñ</a>
    </nav>

    <div class="tables" id="sideTables"></div>
  </aside>

  <main class="main">
    <h1>Nowe zam√≥wienie</h1>

    <label for="tableSelect"><strong>Stolik:</strong></label>
    <select id="tableSelect"></select>
    <br><br><br>

    <div class="order-wrapper">
      <div class="category-tabs">
        {% for category, items in menu.items() %}
        <button class="category-tab {% if loop.first %}active{% endif %}" onclick="showCategory(event, '{{ category|lower }}')">
          {{ category.capitalize() }}
        </button>
        {% endfor %}
      </div>

      <div class="menu-display">
        {% for category, items in menu.items() %}
        <div class="menu-category {% if loop.first %}active{% endif %}" id="{{ category|lower }}">
          {% for item in items %}
          <div class="menu-item" onclick="addToOrder({{ item.id }}, '{{ item.name }}', {{ item.price }}, {{ item.prep_time }})">
            <img src="{{ item.image }}" alt="{{ item.name }}">
            <div><strong>{{ item.name }}</strong></div>
            <div>{{ item.price }} PLN / {{ item.prep_time }} min</div>
          </div>
          {% endfor %}
        </div>
        {% endfor %}
      </div>

      <div class="right-panel">
        <div class="order-summary">
          <h3>Zam√≥wienie nr: <span id="orderIdDisplay">‚Äì</span></h3>
          <ul id="orderList"></ul>
          <p><strong>Suma:</strong> <span id="totalAmount">0</span> PLN</p>
          <p><strong>Czas przygotowania:</strong> <span id="totalTime">0</span> min</p>

          <br><br>
          <label for="orderComment"><strong>Preferencje / komentarz:</strong></label>
            <textarea id="orderComment" rows="2" style="width: 100%;"></textarea>

          <br><br>

          <button id="submitOrder">Wy≈õlij do kuchni</button>
          <br><br>
          <button id="markPaid" style="display:none">‚úÖ Oznacz jako op≈Çacone</button>

          <button id="reserveButton" style="display:none" onclick="updateStatus(tableSelect.value, 'RE')">
            üìå Zarezerwuj stolik
          </button>
          <button id="releaseReservation" style="display:none" onclick="confirmRelease()">
            üîÅ Zwolnij rezerwacjƒô
          </button>


          <button id="markPaid" onclick="markAsPaid()" style="display: none; background-color: #c3e6cb;">
            ‚úÖ Oznacz jako op≈Çacone
          </button>



          <div class="success-message" id="successMessage">Zam√≥wienie wys≈Çane!</div>
          <p id="tableNote" class="info-red"></p>

        </div>

        <div class="client-section">
          <label>Alergeny:</label>
          <div id="allergyList"></div>
          <br>
          <ul id="allergenResults"></ul>
          <div><strong>Tego unikaj:</strong>
            <ul id="recommendations" style="margin: 6px 0; padding-left: 18px;"></ul>
          </div>

        </div>

    </div>
  </main>

<script>
let order = [];
let currentOrderId = null;

function showCategory(event, id) {
  document.querySelectorAll('.menu-category').forEach(c => c.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
  event.target.classList.add('active');
}

function addToOrder(id, name, price, prep_time) {
  const existing = order.find(i => i.id === id);
  if (existing) {
    existing.qty += 1;
    existing.total_price += price;
  } else {
    order.push({ id, name, price, prep_time, qty: 1, total_price: price });
  }
  updateSummary();
}

function updateSummary() {
  const list = document.getElementById('orderList');
  const amount = document.getElementById('totalAmount');
  const time = document.getElementById('totalTime');
  list.innerHTML = '';
  let total = 0, prep = 0;
  order.forEach(item => {
    const li = document.createElement('li');
    li.innerText = `${item.qty}x ${item.name} ‚Äì ${item.total_price.toFixed(2)} PLN`;
    list.appendChild(li);
    total += item.total_price;
    prep += item.qty * item.prep_time;
  });
  amount.innerText = total.toFixed(2);
  time.innerText = prep;
  document.getElementById('orderIdDisplay').innerText = currentOrderId ?? '‚Äì';
}

async function submitOrder() {
  if (order.length === 0) return alert("Zam√≥wienie jest puste.");
  const tableId = parseInt(document.getElementById('tableSelect').value);

  const payload = {
    table_id: tableId,
    items: order,
    total: parseFloat(document.getElementById('totalAmount').innerText),
    prep_time: parseInt(document.getElementById('totalTime').innerText),
    comment: document.getElementById('orderComment').value
  };

  const endpoint = currentOrderId ? `/api/orders/${currentOrderId}` : '/api/order';
  const method = currentOrderId ? 'PATCH' : 'POST';

  const res = await fetch(endpoint, {
    method,
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });

  if (res.ok) {
    const data = await res.json();
    currentOrderId = data.order_id ?? currentOrderId;
    await loadTables();
    await handleTableClick(tableId, 'OJ');
    document.getElementById('successMessage').style.display = 'block';
  } else {
    alert("B≈ÇƒÖd przy wysy≈Çaniu zam√≥wienia.");
  }
}

async function markAsPaid() {
  if (!currentOrderId) return;
  await fetch(`/api/orders/pay/${currentOrderId}`, { method: 'POST' });
  alert("Zam√≥wienie op≈Çacone. Stolik zwolniony.");
  currentOrderId = null;
  order = [];
  updateSummary();

  document.getElementById('orderComment').value = '';
  
  await loadTables();
}

async function updateStatus(tableId, newStatus) {
  await fetch(`/api/tables/${tableId}/status`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ status: newStatus })
  });
  await loadTables();
}

function confirmRelease() {
  const tableId = document.getElementById('tableSelect').value;
  if (confirm("Czy na pewno chcesz zwolniƒá rezerwacjƒô tego stolika?")) {
    updateStatus(tableId, 'wolny');
  }
}

async function loadTables() {
  const res = await fetch('/api/tables');
  const data = await res.json();
  const select = document.getElementById('tableSelect');
  const side = document.getElementById('sideTables');
  select.innerHTML = '';
  side.innerHTML = '';

  const statusMap = {
    'OP': 'Oczekuje na p≈Çatno≈õƒá',
    'OJ': 'Oczekuje na jedzenie',
    'RE': 'Zarezerwowany',
    'wolny': 'Wolny'
  };
  const statusClass = {
    'OP': 'stol-op',
    'OJ': 'stol-oj',
    'RE': 'stol-re',
    'wolny': 'stol-wolny'
  };

  data.forEach(stol => {
    const opt = document.createElement('option');
    opt.value = stol.id;
    opt.textContent = `St√≥≈Ç ${stol.number} ‚Äì ${statusMap[stol.status]}`;
    opt.className = statusClass[stol.status];
    select.appendChild(opt);

    const btn = document.createElement('button');
    btn.textContent = `St√≥≈Ç ${stol.number} ‚Äì ${statusMap[stol.status]}`;
    btn.className = statusClass[stol.status];
    btn.onclick = () => handleTableClick(stol.id, stol.status);
    side.appendChild(btn);
  });
}

async function handleTableClick(id, status) {
  document.getElementById('tableSelect').value = id;
  const note = document.getElementById('tableNote');
  const reserveBtn = document.getElementById('reserveButton');
  const releaseBtn = document.getElementById('releaseReservation');
  const markPaidBtn = document.getElementById('markPaid');

  document.getElementById('orderComment').value = '';

  order = [];
  currentOrderId = null;
  updateSummary();
  note.textContent = '';
  reserveBtn.style.display = 'none';
  releaseBtn.style.display = 'none';
  markPaidBtn.style.display = 'none';

  if (status === 'RE') {
    note.innerHTML = "üî¥ <strong>Stolik zarezerwowany</strong> ‚Äì mo≈ºesz z≈Ço≈ºyƒá zam√≥wienie.";
    releaseBtn.style.display = 'block';
    return;
  }

  if (status === 'wolny') {
    reserveBtn.style.display = 'block';
    return;
  }

  if (status === 'OJ' || status === 'OP') {
    const res = await fetch(`/api/orders/last/${id}`);
    const data = await res.json();
    currentOrderId = data.id;

    order = data.items.map(i => ({
      id: i.id,
      name: i.name,
      qty: i.qty,
      price: i.total / i.qty,
      total_price: i.total,
      prep_time: i.prep_time ?? 10
    }));

    document.getElementById('orderComment').value = data.comment || '';


    updateSummary();
    markPaidBtn.style.display = 'block';
  }
}

async function loadAlergeny() {
  const res = await fetch('/api/alergeny');
  const data = await res.json();
  const list = document.getElementById('allergyList');
  list.innerHTML = '';

  const table = document.createElement('table');
  table.style.width = '100%';
  table.style.borderCollapse = 'collapse';

  data.forEach(al => {
    const row = document.createElement('tr');
    const cellCheck = document.createElement('td');
    const cellLabel = document.createElement('td');

    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.name = 'alergeny';
    checkbox.value = al;

    cellCheck.appendChild(checkbox);
    cellLabel.innerText = al;

    row.appendChild(cellCheck);
    row.appendChild(cellLabel);
    table.appendChild(row);
  });

  list.appendChild(table);

  document.querySelectorAll('input[name="alergeny"]').forEach(cb => {
    cb.addEventListener('change', updateRecommendations);
  });

}

function updateRecommendations() {
  const selected = Array.from(document.querySelectorAll('input[name="alergeny"]:checked')).map(cb => cb.value);

  const list = document.getElementById('recommendations');

  if (selected.length === 0) {
    list.innerHTML = '<li>‚Äì</li>';
    return;
  }

  const riskyItems = [];
  for (const category of Object.values(menuData)) {
    for (const item of category) {
      if (item.allergens && selected.some(al => item.allergens.includes(al))) {
        riskyItems.push(item.name);
      }
    }
  }

  list.innerHTML = riskyItems.length
    ? riskyItems.map(name => `<li>${name}</li>`).join('')
    : '<li>Brak konflikt√≥w</li>';
}

// Init
document.getElementById('submitOrder').onclick = submitOrder;
document.getElementById('markPaid').onclick = markAsPaid;
loadTables();
loadAlergeny();
</script>
</body>
</html>